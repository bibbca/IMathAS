var MQeditor=function(e){var t={layoutstyle:"auto",layout:[]},a={},s=!1,n=null,o=null,r=null,l=MathQuill.getInterface(MathQuill.getInterface.MAX),i=["alpha","beta","chi","delta","epsilon","gamma","varphi","phi","psi","sigma","rho","theta","lambda","mu","nu","omega","tau"];function c(){try{return window.self!==window.top}catch(e){return!0}}function d(s,n,o){"string"==typeof s&&(s=document.getElementById(s));var r="boolean"==typeof n?n:"hidden"!=s.type,c=s.id,d=s.getAttribute("data-mq")||"";if(!0===r){var u=e(s).attr("type","hidden").val();t.hasOwnProperty("toMQ")&&(u=t.toMQ(u,c));var h=e("#mqinput-"+c);if(0==h.length){var p,q=e("<span/>",{id:"mqinput-"+c,class:"mathquill-math-field",text:u,"aria-label":s.getAttribute("aria-label")});null!==(p=s.className.match(/(ansred|ansyel|ansgrn|ansorg)/))&&q.addClass(p[0]),d.match(/chem/)&&q.addClass("mq-chem");var b=s.hasAttribute("size")?s.size>3?s.size/1.8:s.size:10;q.css("min-width",b+"em"),q.insertAfter(s);var v={handlers:{edit:f,enter:y}};t.hasOwnProperty("getLayoutstyle")?t.curlayoutstyle=t.getLayoutstyle():"auto"==t.layoutstyle?t.curlayoutstyle=g():t.curlayoutstyle=t.layoutstyle,"OSK"==t.curlayoutstyle&&(v.substituteTextarea=function(){var e=document.createElement("span");return e.setAttribute("tabindex",0),e},v.keyboardPassthrough=!0),d.match(/chem/)&&(v.charsThatBreakOutOfSupSubVar="",v.charsThatBreakOutOfSupSubOp="",v.autoSubscriptNumerals=!0),d.match(/(list|ntuple)/)&&(v.charsThatBreakOutOfSupSub="=<>,"),d.match(/allowplusminus/)&&(v.quickplusminus=!0),v.autoOperatorNames=v.autoParenOperators="ln log abs exp sin cos tan arcsinh arccosh arctanh arcsech arccsch arccoth argsinh argcosh argtanh argsech argcsch argcoth arsinh arcosh artanh arsech arcsch arcoth arcsin arccos arctan sec csc cot arcsec arccsc arccot sinh cosh sech csch tanh coth",v.autoCommands="pi theta root sqrt ^oo degree",d.match(/logic/)&&(v.autoCommands+=" neg xor or and implies iff"),d.match(/setexp/)&&(v.autoCommands+=" nn xor uu ominus cap cup oplus");var w,C=s.getAttribute("data-mq-vars")||"";if(""!=C){C=""==C?[]:C.split(/,/);for(var k=0;k<C.length;k++){w=C[k].split(/_/);for(var O=0;O<w.length;O++)w[O].length>1&&w[O].match(/^[a-zA-Z]+$/)&&(-1!=i.indexOf(w[O].toLowerCase())?v.autoCommands+=" "+w[O]:v.autoOperatorNames+=" "+w[O])}}s.disabled?(h=l.StaticMath(q[0]),q.addClass("disabled")):(h=l.MathField(q[0],v).config(a),m(q),e(s).on("change.mqed",(function(e,a){if(!a){var n=s.value;t.hasOwnProperty("toMQ")&&(n=t.toMQ(n,s.id)),h.latex(n)}})))}else h.show(),h=l(h[0]).latex(u);!0!==o&&h.focus()}else e(s).attr("type","text").off("change.mqed"),!0!==o&&e(s).focus(),e("#mqinput-"+c).hide()}function m(a){e(a).find(".mq-textarea > *").on("focus.mqeditor",u).on("blur.mqeditor",(function(){o=setTimeout(h,100),t.hasOwnProperty("onBlur")&&t.onBlur()})),e(a).on("click.mqeditor",(function(t){var a=e(t.target).closest("label");if(a.length>0)return"undefined"!==a.attr("for")&&e("#"+a.attr("for")).prop("checked",!0),t.stopPropagation(),!1}))}function u(a){clearTimeout(o);var r=e(a.target).closest(".mathquill-math-field");!1===s&&(e("body").append(e("<div/>",{id:"mqeditor",class:"mqeditor"})),e("#mqeditor").on("mousedown touchstart",(function(e){e.preventDefault()})),s=!0);var i=t.curlayoutstyle;if(t.hasOwnProperty("getLayoutstyle")?t.curlayoutstyle=t.getLayoutstyle():"auto"==t.layoutstyle?t.curlayoutstyle=g():t.curlayoutstyle=t.layoutstyle,"OSK"===t.curlayoutstyle){if(c()?e("#mqeditor").addClass("iframeosk").removeClass("fixedbottom"):e("#mqeditor").addClass("fixedbottom").removeClass("iframeosk"),!document.getElementById("mqe-fb-spacer")){var d=document.createElement("div");d.style.height="200px",d.id="mqe-fb-spacer",e("body").append(d)}}else e("#mqeditor").removeClass("fixedbottom iframeosk");e("#mqeditor").toggleClass("mq-chem",e(r).hasClass("mq-chem"));var m=!1;if((null===n||r[0]!=n.el()||i!==t.curlayoutstyle)&&(m=!0,null!==n&&e("#"+n.el().id.substring(8)).trigger("change",!0),t.hasOwnProperty("getLayout")&&(t.layout=t.getLayout(r[0],t.curlayoutstyle)),e("#mqeditor").empty().show(),t.layout.tabs?function(t,a,s){var n=document.createElement("div");n.className="mqed-row mqed-tabrow";var o,r,l=document.createElement("div");t.appendChild(n),t.appendChild(l);for(var i=0;i<a.tabs.length;i++)if(!0===a.tabs[i].enabled){b(n,a.tabs[i],s+"-"+i),(r=document.createElement("div")).className="mqed-row mqed-tabpanel",r.id=s+"-"+i+"-tabpanel",l.appendChild(r);for(var c=0;c<a.tabs[i].tabcontent.length;c++)(o=a.tabs[i].tabcontent[c]).hasOwnProperty("flow")&&0==o.contents.length||(o.hasOwnProperty("flow")?q(r,o,s+"-"+i+"-"+c):b(r,o,s+"-"+i+"-"+c))}b(n,{s:1}),b(n,{p:"&times;",c:"close",lb:"close"}),e(t).find(".mqed-tab").first().addClass("mqed-activetab")}(document.getElementById("mqeditor"),t.layout,"mqeditor"):q(document.getElementById("mqeditor"),t.layout,"mqeditor"),e("#mqeditor .mqed-btn.rend").each((function(){l.StaticMath(this,{mouseEvents:!1})})),e("#mqeditor .mqed-tabrow").length>0)){e("#mqeditor .mqed-tabpanel").hide().first().show();var u=e("#mqeditor .mqed-tabrow + div");u.css("height",u.height())}"OSK"!==t.curlayoutstyle||c()?e("#mqeditor").show():e("#mqeditor").slideDown(50,(function(){var t=e("#mqeditor").height()+5,a=e(window).height()-(r.offset().top+r.outerHeight()-e(window).scrollTop());a<t&&e(window).scrollTop(e(window).scrollTop()+(t-a))})),p(r),n=l.MathField(r[0]),e("#"+r[0].id.substring(8)).triggerHandler("focus"),t.hasOwnProperty("onShow")&&t.onShow(r[0],t.curlayoutstyle,m),e(document).trigger("mqeditor:show")}function h(a){n&&(e(document).trigger("mqeditor:hide"),"OSK"!==t.curlayoutstyle||c()?e("#mqeditor").hide():e("#mqeditor").slideUp(50),e("#"+n.el().id.substring(8)).trigger("change",!0),n=null)}function p(a){if("under"==t.curlayoutstyle||c()){var s=e(a).closest(".mathquill-math-field"),n=s.offset(),o=s.outerHeight(),r=n.left;if(document.getElementById("mqeditor")){var l=document.getElementById("mqeditor").offsetWidth;r+l>document.documentElement.clientWidth&&(r=document.documentElement.clientWidth-l-5)}c()?e("#mqeditor").css("top",n.top+o+3).css("left",0):e("#mqeditor").css("top",n.top+o+3).css("left",r)}else e("#mqeditor").css("top","auto").css("left",0)}function f(a){var s=a.el();if(p(s),t.hasOwnProperty("onResize")&&t.onResize(s,t.curlayoutstyle),s.id.match(/mqinput/)){var n=a.latex();t.hasOwnProperty("fromMQ")&&(n=t.fromMQ(n,s.id)),e("#"+s.id.substring(8)).val(n).trigger("input"),""!=n&&e("#"+s.id.substring(8)).siblings("input[id^=qs][value=spec]").prop("checked",!0),t.hasOwnProperty("onEdit")&&t.onEdit(s.id,n)}}function y(e){t.hasOwnProperty("onEnter")&&t.onEnter(e.el().id)}function g(){var e=document.documentElement.clientWidth;return navigator.userAgent.match(/Android/)||navigator.userAgent.match(/iPhone/)||navigator.userAgent.match(/iPad/)||e<500?"OSK":"under"}function q(e,t,a){var s=t.flow,n=100;t.hasOwnProperty("s")&&"row"==s&&(n=t.s);var o=document.createElement("div");t.hasOwnProperty("s")&&(o.style.flexGrow=t.s),t.hasOwnProperty("class")&&(o.className=t.class),t.hasOwnProperty("tabpanel")&&(o.id=t.tabpanel.id,o.style.display=t.tabpanel.hidden?"none":""),(d=document.createElement("div")).className="mqed-"+s;for(var r,l=0,i=0,c=0;c<t.contents.length;c++)if(!(r=t.contents[c]).hasOwnProperty("flow")||0!=r.contents.length){var d;if(l+(i=r.hasOwnProperty("s")?r.s:1)>n)o.appendChild(d),l=0,(d=document.createElement("div")).className="mqed-"+s;r.hasOwnProperty("flow")?q(d,r,a+"-"+c):b(d,r,a+"-"+c),l+=i}o.appendChild(d),e.appendChild(o)}function b(a,s,o){var l,i,c,d;if((i=document.createElement("div")).className="mqed-btn-cont",s.s&&(i.style.flexGrow=s.s),s.contid&&(i.id=s.contid),s.contclass&&e(i).addClass(s.contclass),a.appendChild(i),s.l||s.b||s.p){if((l=document.createElement("span")).tabIndex=0,s.l){if(s.op)l.className="mqed-btn mq-math-mode",l.innerHTML='<span class="mq-root-block"><var class="mq-operator-name">'+s.l.substring(1)+"</var></span>";else if(s.pr)l.className="mqed-btn mq-math-mode",l.innerHTML='<span class="mq-root-block">'+s.pr+"</span>";else if(s.l.match(/\\left(.)\\right(.)/)){var m=s.l.match(/\\left(.)\\right(.)/);l.className="mqed-btn mq-math-mode",l.innerHTML='<span class="mq-non-leaf"><span class="mq-scaled mq-paren" style="transform: scale(1, 1.2);">'+m[1]+'</span><span class="mq-non-leaf mq-empty"></span><span class="mq-scaled mq-paren" style="transform: scale(1, 1.2);">'+m[2]+"</span></span>"}else l.className="mqed-btn rend",l.innerText=s.l;c="c",d=s.l.substring(1)}else s.b?(s.r?(l.className="mqed-btn rend",l.innerHTML=s.b):(l.className="mqed-btn mq-math-mode",s.v?l.innerHTML='<span class="mq-root-block"><var>'+s.b+"</var></span>":l.innerHTML='<span class="mq-root-block"><span>'+s.b+"</span></span>"),c="t",((d=s.b).match(/^\d$/)||"."==d)&&e(l).addClass("mqed-digitkey")):(l.className="mqed-btn",l.innerHTML=s.p,c="t",d=s.p);s.c&&("shift"==(c=s.c)?e(l).addClass("mqed-shift"):"k"==c?e(l).addClass("mqed-navkey"):"close"==c&&e(l).addClass("mqed-closebtn")),s.lb&&l.setAttribute("aria-label",s.lb),s.sm&&(l.style.fontSize=100-10*s.sm+"%"),s.w&&(d=s.w),s.tabcontent&&(e(l).addClass("mqed-tab"),c="showtabpanel",d=o+"-tabpanel"),e(l).data("cmdtype",c).data("cmdval",d),e(l).on("click mousedown touchstart keydown",function(a,s){return function(o){!function a(s,o,l){if("mousedown"==s.type&&"Backspace"!==l)return;if("click"==s.type&&"Backspace"===l)return;if("keydown"==s.type&&"Enter"!==s.key)return;"touchstart"==s.type&&(s.preventDefault(),e(s.currentTarget).addClass("mactive"));if("t"==o)l.match(/^[a-zA-Z]$/)&&e(s.target).closest(".mqed-tabpanel").find(".mqed-shift").hasClass("active")&&(l=l.toUpperCase()),n.typedText(l);else if("c"==o)n.cmd(l);else if("l"==o)n.latex(l);else if("w"==o){if(n.write(l),m=l.match(/bmatrix}(.*?)(\\\\|\\end{bm)/))for(var i=m[1].split(/&/).length,c=0;c<i;c++)n.keystroke("Left")}else if("k"==o)n.keystroke(l),"Backspace"===l&&(r=setTimeout((function(){a(s,o,l)}),null===r?600:70));else if("m"==o)n.matrixCmd(l);else if("f"==o){(d=n.getSelection())?(n.write(l+"\\left("+d+"\\right)"),n.keystroke("Left")):l.match(/{}$/)?n.typedText(l.replace(/{}$/,"")):n.write(l)}else if("sf"==o){(d=n.getSelection())?n.write(l+"{"+d+"}"):n.cmd(l),n.keystroke("Left")}else if("i"==o){var d;if((d=n.getSelection())||(d=""),"string"==typeof l){var u=l.charAt(0),h=l.charAt(1);n.write("\\left"+u+d+"\\right"+h)}else n.write(l[0]+d+l[1]);""==d&&n.keystroke("Left")}else if("showtabpanel"==o){(p=e(s.target).closest(".mqed-btn")).closest(".mqeditor").find(".mqed-tabpanel").hide(),p.closest(".mqeditor").find(".mqed-btn.mqed-activetab").removeClass("mqed-activetab"),e("#"+l).show(),p.addClass("mqed-activetab"),t.hasOwnProperty("onTab")&&t.onTab(p[0],t.curlayoutstyle,l)}else if("shift"==o){var p=e(s.target).closest(".mqed-btn"),f=e(s.target).closest(".mqed-tabpanel"),y=!p.hasClass("active");y?p.addClass("active"):p.removeClass("active"),f.find(".mqed-btn").each((function(e,t){t.textContent.match(/^[a-zA-Z]$/)&&(t.textContent=y?t.textContent.toUpperCase():t.textContent.toLowerCase())}))}else"close"==o&&n.blur()}(o,a,s)}}(c,d)).on("touchend",(function(t){setTimeout((function(){e(t.currentTarget).removeClass("mactive")}),50)})).on("touchend mouseup",(function(){clearTimeout(r),r=null})),i.appendChild(l)}}return{setConfig:function(e){for(var a in e)t[a]=e[a]},setMQconfig:function(e){a=e},toggleMQ:d,toggleMQAll:function(t,a){var s=a||null;e(t).each((function(e,t){d(t,s,!0)}))},attachEditor:m,getLayoutstyle:g,resetEditor:function(){clearTimeout(o),e("#mqeditor").hide(),n=null}}}(jQuery);